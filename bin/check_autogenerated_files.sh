#!/bin/bash
set -euo pipefail

# ###
# check_autogenerated_files.sh
# ###
# Makes sure that autogenerated files were regenerated after making changes to the source.
# ###
echo "Checking if there are unstaged changes"
GIT_DIFF=$(git diff)

if [ -n "$GIT_DIFF" ]
then
  echo "There are unstaged changes. Stage them (git add) or remove them for this check to be able to work."
  exit 1
fi;

echo "Downloading configlet"
bin/fetch-configlet
echo "Running 'configlet generate'"
bin/configlet generate

echo "Checking git diff"
GIT_DIFF=$(git diff)

if [ -z "$GIT_DIFF" ]
then
  echo "Autogenerated files check passed"
  exit 0
else
  echo "$GIT_DIFF"
  echo "Autogenerated files check failed. Please run \`configlet generate\` and commit in the changes."
  exit 1
fi;
